<html>
<head>
    <style>
        .y-axis>path {
            stroke: rgb(193, 193, 193);
            fill: none;
        }

        .tick>line {
            display: none;
        }

        body {
            font-family:"avenir next", Arial, sans-serif;
            font-size: 12px;
            color: #696969;
        }

        .ticks {
            font-size: 10px;
        }

        .track,
        .track-inset,
        .track-overlay {
            stroke-linecap: round;
        }

        .track {
            stroke: #000;
            stroke-opacity: 0.3;
            stroke-width: 10px;
        }

        .track-inset {
            stroke: #dcdcdc;
            stroke-width: 8px;
        }

        .track-overlay {
            pointer-events: stroke;
            stroke-width: 50px;
            stroke: transparent;
            cursor: crosshair;
        }

        .handle {
            fill: #fff;
            stroke: #000;
            stroke-opacity: 0.5;
            stroke-width: 1.25px;
        }
    </style>
    <link rel="stylesheet" href="skeleton.css">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans:700|Roboto" rel="stylesheet">
    <script src="d3.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>How has life expectancy changed?</h1>
        <div class="slider"></div>
        <div class="chart"></div>
        <footer class="u-pull-right"><a href="https://data.world/makeovermonday/life-expectancy-at-birth-by-country">Life Expectancy at Birth</a></footer>
    </div>
</body>
<script>

    ////////////////////////////////////////////////////////////////////////////////
    /////////////////////////// CREATE A LINE CHART CLASS //////////////////////////
    ////////////////////////////////////////////////////////////////////////////////
    class lineChart {
        constructor(opts) {
            this.element = opts.element;
            this.width = opts.width;
            this.height = opts.height;
            this.margin = opts.margin;
            this.padding = opts.padding;
            this.OGdata = opts.originalData;
            this.data = opts.transformedData;

            // Create additional setup variables we'll need locally based on the options above
            this.plotWidth = this.width - (this.margin.left + this.margin.right);
            this.plotHeight = this.height - (this.margin.top + this.margin.bottom);
            this.chartWidth = this.plotWidth - (this.padding.right + this.padding.left);
            this.chartHeight = this.plotHeight - (this.padding.top + this.padding.bottom);

            this.setupChartArea();
            this.createScales();
            this.createSlider();
            this.createLine();
            this.createAxes();
        }

        setupChartArea() {
            const svg = d3.select(this.element).append('svg')
                .attr('width', this.width)
                .attr('height', this.height)

            this.plot = svg.append('g')
                .classed('plot', true)
                .attr('transform', `translate(${this.margin.left}, ${this.margin.top})`)
                .attr('width', this.width - (this.margin.left + this.margin.right))
                .attr('height', this.height - (this.margin.top + this.margin.bottom))
        }

        createScales() {

            this.xScale = d3.scaleLinear()
                .domain(d3.extent(this.OGdata, d => +d.year))
                .range([this.padding.left, this.width - this.padding.right])

            this.yScale = d3.scaleLinear()
                .domain([d3.min(this.data, d => d.minLE), d3.max(this.data, d => d.maxLE)])
                .range([this.height - this.padding.bottom, this.padding.top])

            ////////////////////////////////////////////////////////////////////////////////
            ///////////////////////////// CREATE LINE GENERATOR ////////////////////////////
            ////////////////////////////////////////////////////////////////////////////////
            this.lineGenerator = d3.line()
                .x( d => this.xScale(d.year) )
                .y( d => this.yScale(d.life) )
	            .curve(d3.curveCardinal);

        }

        createAxes() {
            this.yAxis = d3.axisRight()
                .scale(this.yScale)

            this.refLine = this.plot.append('g')
                .classed('y-axis', true)
                .attr('transform', `translate(${this.xScale(1961)}, ${this.padding.top})`)
                .call(this.yAxis);

            this.yTick = this.refLine.selectAll('text')
                .attr('text-anchor', 'middle')
                .attr('x', 0)
                .attr('font-size', 12)
        }

        createSlider() {
            const startDate = 1961;
            const endDate = 2015;

            const margin = {top:0, right:50, bottom:0, left:50},
                width = 960 - margin.left - margin.right,
                height = 200 - margin.top - margin.bottom;

            ////////// slider //////////

            const svgSlider = d3.select(".slider")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height);
                
            const x = d3.scaleLinear()
                .domain([startDate, endDate])
                .range([0, width])
                .clamp(true);

            const slider = svgSlider.append("g")
                .attr("class", "slider")
                .attr("transform", "translate(" + margin.left + "," + height / 2 + ")");

            slider.append("line")
                .attr("class", "track")
                .attr("x1", x.range()[0])
                .attr("x2", x.range()[1])
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                .attr("class", "track-inset")
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                .attr("class", "track-overlay")
                .call(d3.drag()
                    .on("start.interrupt", function() { slider.interrupt(); })
                    .on("start drag", function() { update(x.invert(d3.event.x)) })); //this.update(x.invert(d3.event.x)); })); // this.update(x.invert(d3.event.x));

            slider.insert("g", ".track-overlay")
                .attr("class", "ticks")
                .attr("transform", "translate(0," + 18 + ")")
            .selectAll("text")
                .data(x.ticks(10))
                .enter()
                .append("text")
                .attr("x", x)
                .attr("y", 10)
                .attr("text-anchor", "middle")
                .text(function(d) { return d; });

            const handle = slider.insert("circle", ".track-overlay")
                .attr("class", "handle")
                .attr("r", 9);

            const label = slider.append("text")  
                .attr("class", "label")
                .attr("text-anchor", "middle")
                .text(startDate)
                .attr("transform", "translate(0," + (-25) + ")")

            function update(h) {
                // update position and text of label according to slider scale
                handle.attr("cx", x(h));

                label
                    .attr("x", x(h))
                    .text(Math.round(h));

                this.refLine
                    .attr('transform', `translate(${x(h)}, ${this.padding.top})`)

                

            }  
 
        }

        createLine() {

            this.line = d3.select('.plot')
                .selectAll('path').data(this.data, d => d.country);

            this.lineEnter = this.line.enter()
                .append('path')
                    .attr('fill', 'none')
                    .attr('stroke', 'steelblue')
                    .attr('stroke-width', 1.5)
                    .attr('d', d => this.lineGenerator(d.years));
        }
    }

    ////////////////////////////////////////////////////////////////////////////////
    ////////////////////////// LOAD DATA FOR THE 1ST TIME //////////////////////////
    ////////////////////////////////////////////////////////////////////////////////
    d3.csv('life-expectancy.csv').then( data => {
        function initializeData(data) {
            const compYear = '1961'

            const nested = d3.nest()
                .key(d => d.country)
                .entries(data);

            const transformedData = [];

            // let compCountry = Array.from(data.filter(d => d.country == country.key));
            // let compLifeE = +Array.from(compCountry.filter(d => '1963' == d.year)['life-expectancy']);

            for(const country of Array.from(nested)) {

                const obj = {
                        baseline: +Array.from(data.filter(d => d.country == country.key)).filter(d => d.year == '1961')[0]['life-expectancy'],
                        years: []
                    }
                
                obj.country = country.key;
                
                for(const year of country.values) {

                    obj.years.push({
                        year: +year.year,
                        life: +year['life-expectancy'] - obj.baseline
                    })
                }

                transformedData.push(obj);

                for(const object of transformedData) {
                    [object.minLE, object.maxLE] = d3.extent(object.years, d => d.life);
                }

            }

            return transformedData;
        }

        ////////////////////////////////////////////////////////////////////////////////
        ////////////////////////////// SET THE CHART SIZE //////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////
        const width = 960;
        const height = 500;
        const margin = {top: 10, right: 10, bottom: 10, left: 10};
        const padding = {top: 10, right: 10, bottom: 10, left: 10};

        ////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////// CREATE NEW CHART ///////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////
        const chart = new lineChart({
            element: document.querySelector('.chart'),
            width,
            height,
            margin,
            padding,
            originalData: data,
            transformedData: initializeData(data)
        });

    });
</script>
</html>