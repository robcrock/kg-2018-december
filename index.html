<html>
<head>
    <style>
        .y-axis>path {
            stroke: rgb(193, 193, 193);
            fill: none;
        }

        .tick>line {
            display: none;
        }

        body {
            font-family:"avenir next", Arial, sans-serif;
            font-size: 12px;
            color: #696969;
        }

        .ticks {
            font-size: 10px;
        }

        .track,
        .track-inset,
        .track-overlay {
            stroke-linecap: round;
        }

        .track {
            stroke: #000;
            stroke-opacity: 0.3;
            stroke-width: 10px;
        }

        .track-inset {
            stroke: #dcdcdc;
            stroke-width: 8px;
        }

        .track-overlay {
            pointer-events: stroke;
            stroke-width: 50px;
            stroke: transparent;
            cursor: crosshair;
        }

        .handle {
            fill: #fff;
            stroke: #000;
            stroke-opacity: 0.5;
            stroke-width: 1.25px;
        }
    </style>
    <link rel="stylesheet" href="skeleton.css">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans:700|Roboto" rel="stylesheet">
    <script src="js/d3.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>How has life expectancy changed?</h1>
        <div class="slider"></div>
        <div class="chart"></div>
        <footer class="u-pull-right"><a href="https://data.world/makeovermonday/life-expectancy-at-birth-by-country">Life Expectancy at Birth</a></footer>
    </div>
</body>
<script src='js/d3.js'></script>
<script src='js/lodash.js'></script>
<script src='js/analysis.js'></script>
<script>

    ////////////////////////////////////////////////////////////////////////////////
    /////////////////////////// CREATE A LINE CHART CLASS //////////////////////////
    ////////////////////////////////////////////////////////////////////////////////
    class LineChart {
        constructor(opts) {
            this.element = opts.element;
            this.width = opts.width;
            this.height = opts.height;
            this.margin = opts.margin;
            this.padding = opts.padding;
            this.data = opts.data;

            // Create additional setup variables we'll need locally based on the options above
            this.plotWidth = this.width - (this.margin.left + this.margin.right);
            this.plotHeight = this.height - (this.margin.top + this.margin.bottom);
            this.chartWidth = this.plotWidth - (this.padding.right + this.padding.left);
            this.chartHeight = this.plotHeight - (this.padding.top + this.padding.bottom);
            
            this.updateData(this.data);
            this.setupChartArea();
            this.createScales();
            this.createSlider();
            this.createLine();
            this.createAxes();
        }

        updateData(data) {

            const baselineYear = data.filter(d => d.year == '1981');

            for(const row of data) {
                row.year = +row.year;
                row.le = +row['life-expectancy'];
                delete row['life-expectancy'];
            }

            this.transformedData = d3.nest()
                .key(d => d.country)
                .entries(data);

            for(const country of this.transformedData) {
                let baselineCountry = baselineYear.filter(d => d.country === country.key);
                for(const value of country.values) {
                    value.diff = value.le - baselineCountry[0].le;
                }
            }

            console.log(this.transformedData);

            return this.transformedData;
        }

        setupChartArea() {
            const svg = d3.select(this.element).append('svg')
                .attr('width', this.width)
                .attr('height', this.height)

            this.plot = svg.append('g')
                .classed('plot', true)
                .attr('transform', `translate(${this.margin.left}, ${this.margin.top})`)
                .attr('width', this.width - (this.margin.left + this.margin.right))
                .attr('height', this.height - (this.margin.top + this.margin.bottom))
        }

        createScales() {

            this.xScale = d3.scaleLinear()
                .domain(d3.extent(this.data, d => +d.year))
                .range([this.padding.left, this.width - this.padding.right])

            this.yScale = d3.scaleLinear()
                .domain([-50, 50]) //[d3.min(this.transformedData, d => d.minLE), d3.max(this.transformedData, d => d.maxLE)])
                .range([this.height - this.padding.bottom, this.padding.top])

            ////////////////////////////////////////////////////////////////////////////////
            ///////////////////////////// CREATE LINE GENERATOR ////////////////////////////
            ////////////////////////////////////////////////////////////////////////////////
            this.lineGenerator = d3.line()
                .x( d => this.xScale(d.year) )
                .y( d => this.yScale(d.diff) )
	            .curve(d3.curveCardinal);

        }

        createAxes() {
            this.yAxis = d3.axisRight()
                .scale(this.yScale)

            this.refLine = this.plot.append('g')
                .classed('y-axis', true)
                .attr('transform', `translate(${this.xScale(1981)}, ${this.padding.top})`)
                .call(this.yAxis);

            this.yTick = this.refLine.selectAll('text')
                .attr('text-anchor', 'middle')
                .attr('x', 0)
                .attr('font-size', 12)
        }

        createSlider() {
            const startDate = 1961;
            const endDate = 2015;

            const margin = {top:0, right:50, bottom:0, left:50},
                width = 960 - margin.left - margin.right,
                height = 200 - margin.top - margin.bottom;

            ////////// slider //////////

            const svgSlider = d3.select(".slider")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height);

            this.x = d3.scaleLinear()
                .domain([this.xScale.domain()[0], this.xScale.domain()[1]])
                .range([0, width])
                .clamp(true);

            const slider = svgSlider.append("g")
                .attr("class", "slider")
                .attr("transform", "translate(" + margin.left + "," + height / 2 + ")");

            slider.append("line")
                .attr("class", "track")
                .attr("x1", this.x.range()[0])
                .attr("x2", this.x.range()[1])
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                .attr("class", "track-inset")
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                .attr("class", "track-overlay")
                .call(d3.drag()
                    .on("start.interrupt", function() { slider.interrupt(); })
                    .on("start drag", () =>  { this.update(this.x.invert(d3.event.x)) }));

            slider.insert("g", ".track-overlay")
                .attr("class", "ticks")
                .attr("transform", "translate(0," + 18 + ")")
            .selectAll("text")
                .data(this.x.ticks(10))
                .enter()
                .append("text")
                .attr("x", this.x)
                .attr("y", 10)
                .attr("text-anchor", "middle")
                .text(function(d) { return d; });

            this.handle = slider.insert("circle", ".track-overlay")
                .attr("class", "handle")
                .attr('cx', this.x(1981))
                .attr("r", 9);

            this.label = slider.append("text")  
                .attr("class", "label")
                .attr("text-anchor", "middle")
                .text(startDate)
                .attr("transform", `translate(${this.x(1981)}, -25)`)
 
        }

        update(h) {
            // update position and text of label according to slider scale
            this.handle
                .attr("cx", this.x(h));

            this.label
                .attr("transform", `translate(${this.x(h)}, -25)`)
                .text(Math.round(h));

            this.refLine
                .attr('transform', `translate(${this.xScale(h)}, ${this.padding.top})`)

        }  

        createLine() {

            this.line = d3.select('.plot')
                .selectAll('path').data(this.transformedData, d => d.key);

            this.lineEnter = this.line.enter()
                .append('path')
                    .attr('fill', 'none')
                    .attr('stroke', 'steelblue')
                    .attr('stroke-width', 1.5)
                    .attr('d', d => this.lineGenerator(d.values));
        }
    }

    ////////////////////////////////////////////////////////////////////////////////
    ////////////////////////// LOAD DATA FOR THE 1ST TIME //////////////////////////
    ////////////////////////////////////////////////////////////////////////////////
    d3.csv('/data/life-expectancy.csv').then( data => {

        ////////////////////////////////////////////////////////////////////////////////
        ////////////////////////////// SET THE CHART SIZE //////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////
        const width = 960;
        const height = 500;
        const margin = {top: 10, right: 10, bottom: 10, left: 10};
        const padding = {top: 10, right: 10, bottom: 10, left: 10};

        ////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////// CREATE NEW CHART ///////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////
        const chart = new LineChart({
            element: document.querySelector('.chart'),
            width,
            height,
            margin,
            padding,
            data: data
        });

    });
</script>
</html>