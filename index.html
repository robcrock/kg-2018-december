<html>
<head>
    <style>
        .y-axis>path {
            stroke: rgb(193, 193, 193);
            fill: none;
        }
        .tick>line {
            display: none;
        }
    </style>
    <link rel="stylesheet" href="skeleton.css">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans:700|Roboto" rel="stylesheet">
    <script src="d3.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>How has life expectancy changed?</h1>
        <div class="chart"></div>
        <footer class="u-pull-right"><a href="https://data.world/makeovermonday/life-expectancy-at-birth-by-country">Life Expectancy at Birth</a></footer>
    </div>
</body>
<script>

    ////////////////////////////////////////////////////////////////////////////////
    /////////////////////////// CREATE A LINE CHART CLASS //////////////////////////
    ////////////////////////////////////////////////////////////////////////////////
    class lineChart {
        constructor(opts) {
            this.element = opts.element;
            this.width = opts.width;
            this.height = opts.height;
            this.margin = opts.margin;
            this.padding = opts.padding;
            this.OGdata = opts.originalData;
            this.data = opts.transformedData;

            // Create additional setup variables we'll need locally based on the options above
            this.plotWidth = this.width - (this.margin.left + this.margin.right);
            this.plotHeight = this.height - (this.margin.top + this.margin.bottom);
            this.chartWidth = this.plotWidth - (this.padding.right + this.padding.left);
            this.chartHeight = this.plotHeight - (this.padding.top + this.padding.bottom);

            this.setupChartArea();
            this.createScales();
            this.createLine();
            this.createAxes();
        }

        setupChartArea() {
            const svg = d3.select(this.element).append('svg')
                .attr('width', this.width)
                .attr('height', this.height)

            this.plot = svg.append('g')
                .classed('plot', true)
                .attr('transform', `translate(${this.margin.left}, ${this.margin.top})`)
                .attr('width', this.width - (this.margin.left + this.margin.right))
                .attr('height', this.height - (this.margin.top + this.margin.bottom))
        }

        createScales() {

            this.xScale = d3.scaleLinear()
                .domain(d3.extent(this.OGdata, d => +d.year))
                .range([this.padding.left, this.width - this.padding.right])

            this.yScale = d3.scaleLinear()
                .domain([d3.min(this.data, d => d.minLE), d3.max(this.data, d => d.maxLE)])
                .range([this.height - this.padding.bottom, this.padding.top])

            ////////////////////////////////////////////////////////////////////////////////
            ///////////////////////////// CREATE LINE GENERATOR ////////////////////////////
            ////////////////////////////////////////////////////////////////////////////////
            this.lineGenerator = d3.line()
                .x( d => this.xScale(d.year) )
                .y( d => this.yScale(d.life) )
	            .curve(d3.curveCardinal);

        }

        createAxes() {
            this.yAxis = d3.axisRight()
                .scale(this.yScale)

            const refLine = this.plot.append('g')
                .classed('y-axis', true)
                .attr('transform', `translate(${this.xScale(1981)}, ${this.padding.top})`)
                .call(this.yAxis);

            this.yTick = refLine.selectAll('text')
                .attr('text-anchor', 'middle')
                .attr('x', 0)
                .attr('font-size', 12)
            
            console.log(this.yTick);
        }

        createLine() {

            this.line = d3.select('.plot')
                .selectAll('path').data(this.data, d => d.country);

            this.lineEnter = this.line.enter()
                .append('path')
                    .attr('fill', 'none')
                    .attr('stroke', 'steelblue')
                    .attr('stroke-width', 1.5)
                    .attr('d', d => this.lineGenerator(d.years));
        }
    }

    ////////////////////////////////////////////////////////////////////////////////
    ////////////////////////// LOAD DATA FOR THE 1ST TIME //////////////////////////
    ////////////////////////////////////////////////////////////////////////////////
    d3.csv('life-expectancy.csv').then( data => {
        function initializeData(data) {
            const compYear = '1981'

            const nested = d3.nest()
                .key(d => d.country)
                .entries(data);

            const transformedData = [];

            // let compCountry = Array.from(data.filter(d => d.country == country.key));
            // let compLifeE = +Array.from(compCountry.filter(d => '1963' == d.year)['life-expectancy']);

            for(const country of Array.from(nested)) {

                const obj = {
                        baseline: +Array.from(data.filter(d => d.country == country.key)).filter(d => d.year == '1981')[0]['life-expectancy'],
                        years: []
                    }
                
                obj.country = country.key;
                
                for(const year of country.values) {

                    obj.years.push({
                        year: +year.year,
                        life: +year['life-expectancy'] - obj.baseline
                    })
                }

                transformedData.push(obj);

                for(const object of transformedData) {
                    [object.minLE, object.maxLE] = d3.extent(object.years, d => d.life);
                }

            }

            return transformedData;
        }

        ////////////////////////////////////////////////////////////////////////////////
        ////////////////////////////// SET THE CHART SIZE //////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////
        const width = 960;
        const height = 500;
        const margin = {top: 10, right: 10, bottom: 10, left: 10};
        const padding = {top: 10, right: 10, bottom: 10, left: 10};

        ////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////// CREATE NEW CHART ///////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////
        const chart = new lineChart({
            element: document.querySelector('.chart'),
            width,
            height,
            margin,
            padding,
            originalData: data,
            transformedData: initializeData(data)
        });
    });
</script>
</html>